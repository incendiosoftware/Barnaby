name: Release

on:
  workflow_dispatch:
    inputs:
      releasable:
        description: "Set true to publish a GitHub release"
        required: true
        type: boolean
        default: true

permissions:
  contents: write

jobs:
  release:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Read app version
        id: app_version
        shell: bash
        run: echo "value=$(node -p \"require('./package.json').version\")" >> "$GITHUB_OUTPUT"

      - name: Build portable artifact (no version bump)
        run: npm run build:portable:raw

      - name: Resolve release notes file
        id: notes
        shell: bash
        run: |
          VERSION="${{ steps.app_version.outputs.value }}"
          NOTES_FILE="RELEASE_NOTES_${VERSION}.md"
          if [ -f "$NOTES_FILE" ]; then
            echo "path=$NOTES_FILE" >> "$GITHUB_OUTPUT"
          else
            FALLBACK="release-notes-${VERSION}.md"
            {
              echo "# Barnaby ${VERSION}"
              echo
              echo "- Automated releasable build."
              echo "- Commit: ${{ github.sha }}"
            } > "$FALLBACK"
            echo "path=$FALLBACK" >> "$GITHUB_OUTPUT"
          fi

      - name: Publish GitHub release
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.app_version.outputs.value }}"
          TAG="v${VERSION}"
          ASSET="release/${VERSION}/Barnaby_${VERSION}_portable.exe"
          NOTES="${{ steps.notes.outputs.path }}"
          TARGET="${{ github.sha }}"

          if gh release view "$TAG" >/dev/null 2>&1; then
            gh release upload "$TAG" "$ASSET" --clobber
            gh release edit "$TAG" --title "$TAG" --notes-file "$NOTES"
          else
            gh release create "$TAG" "$ASSET" --title "$TAG" --notes-file "$NOTES" --target "$TARGET"
          fi
