name: Release

on:
  workflow_dispatch:
    inputs:
      releasable:
        description: "Set true to publish a GitHub release"
        required: true
        type: boolean
        default: true
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  release:
    if: ${{ (github.event_name == 'workflow_dispatch' && github.event.inputs.releasable == 'true') || (github.event_name == 'push' && contains(github.event.head_commit.message, '[release]')) }}
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Read app version
        id: app_version
        shell: bash
        run: echo "value=$(node -p \"require('./package.json').version\")" >> "$GITHUB_OUTPUT"

      - name: Build portable artifact (no version bump)
        run: npm run build:portable:raw

      - name: Resolve release notes file
        id: notes
        shell: bash
        run: |
          VERSION="${{ steps.app_version.outputs.value }}"
          NOTES_FILE="RELEASE_NOTES_${VERSION}.md"
          if [ -f "$NOTES_FILE" ]; then
            echo "path=$NOTES_FILE" >> "$GITHUB_OUTPUT"
          else
            FALLBACK="release-notes-${VERSION}.md"
            {
              echo "# Barnaby ${VERSION}"
              echo
              echo "- Automated releasable build."
              echo "- Commit: ${{ github.sha }}"
            } > "$FALLBACK"
            echo "path=$FALLBACK" >> "$GITHUB_OUTPUT"
          fi

      - name: Publish GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.app_version.outputs.value }}
          name: v${{ steps.app_version.outputs.value }}
          target_commitish: ${{ github.sha }}
          body_path: ${{ steps.notes.outputs.path }}
          files: |
            release/${{ steps.app_version.outputs.value }}/Barnaby_${{ steps.app_version.outputs.value }}_portable.exe
          fail_on_unmatched_files: true
